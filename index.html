<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify-Telegram Sync</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e7;
            padding: 2rem;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.75rem;
            color: #fff;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #a1a1aa;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.green { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-dot.red { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-dot.yellow { background: #eab308; box-shadow: 0 0 8px #eab308; }

        .track-info {
            text-align: center;
        }

        .track-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .track-artist {
            font-size: 1rem;
            color: #1db954;
        }

        .track-album {
            font-size: 0.875rem;
            color: #a1a1aa;
            margin-top: 0.25rem;
        }

        .not-playing {
            text-align: center;
            color: #71717a;
            font-style: italic;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #fff;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #a1a1aa;
            margin-top: 0.25rem;
        }

        .current-name {
            background: rgba(29, 185, 84, 0.1);
            border: 1px solid rgba(29, 185, 84, 0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }

        .current-name-label {
            font-size: 0.75rem;
            color: #a1a1aa;
            margin-bottom: 0.5rem;
        }

        .current-name-value {
            font-size: 1.125rem;
            color: #1db954;
            font-weight: 500;
        }

        .connection-status {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
        }

        .connection-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .error-card {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .error-item {
            font-size: 0.875rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .error-item:last-child {
            border-bottom: none;
        }

        .error-time {
            font-size: 0.75rem;
            color: #a1a1aa;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #a1a1aa;
        }

        .refresh-info {
            text-align: center;
            font-size: 0.75rem;
            color: #71717a;
            margin-top: 1rem;
        }

        .rate-limit-banner {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            color: #eab308;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spotify-Telegram Sync</h1>

        <div id="content">
            <div class="loading">Loading...</div>
        </div>

        <div class="refresh-info">
            Auto-refreshes every 30 seconds
        </div>
    </div>

    <script>
        function formatTimeAgo(seconds) {
            if (!seconds) return 'Never';
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            return `${Math.floor(seconds / 3600)}h ago`;
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp * 1000).toLocaleTimeString();
        }

        function renderStatus(data) {
            const content = document.getElementById('content');

            const telegramStatus = data.connected.telegram ? 'green' : 'red';
            const spotifyStatus = data.connected.spotify ? 'green' : 'red';

            let trackHtml = '';
            if (data.track && data.track.is_playing) {
                trackHtml = `
                    <div class="track-info">
                        <div class="track-title">${escapeHtml(data.track.title)}</div>
                        <div class="track-artist">${escapeHtml(data.track.artist)}</div>
                        ${data.track.album ? `<div class="track-album">${escapeHtml(data.track.album)}</div>` : ''}
                    </div>
                `;
            } else {
                trackHtml = '<div class="not-playing">Nothing playing</div>';
            }

            let rateLimitHtml = '';
            if (data.rate_limit && data.rate_limit.active) {
                rateLimitHtml = `
                    <div class="rate-limit-banner">
                        Rate limited - ${data.rate_limit.remaining_seconds}s remaining
                    </div>
                `;
            }

            let errorsHtml = '';
            if (data.errors && data.errors.length > 0) {
                const errorItems = data.errors.slice(0, 3).map(err => `
                    <div class="error-item">
                        <div>${escapeHtml(err.error)}</div>
                        <div class="error-time">${formatTime(err.timestamp)} - ${err.context}</div>
                    </div>
                `).join('');
                errorsHtml = `
                    <div class="card error-card">
                        <div class="card-header">
                            <span class="card-title">Recent Errors</span>
                        </div>
                        ${errorItems}
                    </div>
                `;
            }

            content.innerHTML = `
                ${rateLimitHtml}

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Connection Status</span>
                    </div>
                    <div class="connection-status">
                        <div class="connection-item">
                            <span class="status-dot ${telegramStatus}"></span>
                            <span>Telegram</span>
                        </div>
                        <div class="connection-item">
                            <span class="status-dot ${spotifyStatus}"></span>
                            <span>Spotify</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Now Playing</span>
                    </div>
                    ${trackHtml}
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Sync Status</span>
                    </div>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-value">${formatTimeAgo(data.sync.last_sync_ago)}</div>
                            <div class="stat-label">Last Sync</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${formatTimeAgo(data.sync.last_update_ago)}</div>
                            <div class="stat-label">Last Update</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${data.sync.update_count}</div>
                            <div class="stat-label">Total Updates</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${data.spotify_token.valid ? Math.floor(data.spotify_token.expires_in / 60) + 'm' : 'Expired'}</div>
                            <div class="stat-label">Token Expires</div>
                        </div>
                    </div>
                    ${data.sync.current_name ? `
                        <div class="current-name">
                            <div class="current-name-label">Current Telegram Name</div>
                            <div class="current-name-value">${escapeHtml(data.sync.current_name)}</div>
                        </div>
                    ` : ''}
                </div>

                ${errorsHtml}
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                renderStatus(data);
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="card error-card">
                        <div class="card-header">
                            <span class="card-title">Error</span>
                        </div>
                        <div>Failed to fetch status: ${escapeHtml(error.message)}</div>
                    </div>
                `;
            }
        }

        // Initial fetch
        fetchStatus();

        // Auto-refresh every 30 seconds
        setInterval(fetchStatus, 30000);
    </script>
</body>
</html>
